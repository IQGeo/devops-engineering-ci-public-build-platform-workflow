name: Reusable Build Workflow Template
description: Template for building module components with common configurations

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      modules:
        description: 'Comma-separated list of modules to build'
        required: false
        type: string
        default: 'vector_tile_styles,reporting_examples,embeddedExamples,dev_db'        
      shortened_version:
        description: 'Shortened version for language packs repo'
        required: true
        type: string
      tags:
        description: 'Comma-separated list of all tags to apply'
        required: true
        type: string
      build_id:
        description: 'Unique build identifier'
        required: true
        type: string
      engineering_prefix:
        description: 'Engineering prefix to place multi arch images in ACR & Harbor'
        type: string
        default: devops_sandbox_engineering
      releases_prefix:
        description: 'Releases prefix to place multi arch images in ACR & Harbor'
        type: string
        default: devops_sandbox_releases
      is_release:
        description: 'Whether this is a pre-release or release version'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace for the deployment'
        type: string
      pod_name:
        description: 'Kubernetes pod name to redeploy after images are built'
        type: string
        default: ''
      build_qa_images:
        description: 'Whether to build QA images (platform with devdb)'
        type: boolean
        default: true        
        
    secrets:
      GH_TOKEN:
        required: true   
      HARBOR_USERNAME:
        required: true
      HARBOR_CLI_SECRET:
        required: true
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true

run-name: Build ${{ inputs.version }}

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      modules_array: ${{ steps.modules.outputs.array }}
      hyphenated_module: ${{ steps.hyphenate.outputs.hyphenated_module }}
    steps:          
      - name: Process modules
        id: modules
        run: |
          # Convert comma-separated string to JSON array
          MODULES_JSON=$(echo "${{ inputs.modules }}" | jq -R 'split(",")' | tr -d '^\n')
          echo "array=$MODULES_JSON" >> $GITHUB_OUTPUT
          echo "Modules array: $MODULES_JSON"

      - name: Hyphenate modules
        id: hyphenate
        run: |
          # Convert module names with underscores to hyphens
          UNDERSCORE_MODULE=${{ fromJson(steps.modules.outputs.array)[0] }}
          HYPHENATED_MODULE=${UNDERSCORE_MODULE//_/-}
          echo "hyphenated_module=$HYPHENATED_MODULE" >> $GITHUB_OUTPUT
          echo "Hyphenated module name: $HYPHENATED_MODULE"
    
    
  # The module is the first item in the modules array defined in the setup step above 
  cut-artifacts:
    uses: ./.github/workflows/cut-platform.yml
    with:
      version: ${{ inputs.version }}
    secrets: inherit
    
  build-injectors:
    needs: [setup, cut-artifacts]
    strategy:
      matrix:
        module: ${{ fromJson(needs.setup.outputs.modules_array) }}
    uses: IQGeo/devops-engineering-ci-public-build-multi-arch-workflow/.github/workflows/build-multi-arch.yml@main
    with:
      version: ${{ inputs.version }}
      dockerfile_path: ".github/workflows/Dockerfile.injector"
      docker_context: "."
      module: ${{ matrix.module }}
      acr: "iqgeoproddev.azurecr.io"
      harbor: "harbor.delivery.iqgeo.cloud"
      updated_tags: ${{ inputs.tags }}
      build_id: ${{ inputs.build_id }}
      shortened_version: ${{ inputs.shortened_version }}
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}/platform
      releases_prefix: ${{ inputs.releases_prefix }}
    secrets: inherit

  # Build base and base-clear images (no dependencies)
  build-platform-base:
    needs: [setup, cut-artifacts]
    uses: IQGeo/devops-engineering-ci-public-build-platform-specialised-image-workflow/.github/workflows/build-specialised-images.yml@main
    with:
      version: ${{ inputs.version }}
      image_types: '["base", "base-clear"]'
      updated_tags: ${{ inputs.tags }}
      shortened_version: ${{ inputs.shortened_version }}      
      build_id: ${{ inputs.build_id }}
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}
      releases_prefix: ${{ inputs.releases_prefix }}
      dev_tools_version: ${{ inputs.version }}
    secrets: inherit

  # Build build and build-clear images (depends on base)
  build-platform-build:
    needs: [setup, build-platform-base]
    uses: IQGeo/devops-engineering-ci-public-build-platform-specialised-image-workflow/.github/workflows/build-specialised-images.yml@main
    with:
      version: ${{ inputs.version }}
      image_types: '["build", "build-clear"]'
      updated_tags: ${{ inputs.tags }}
      shortened_version: ${{ inputs.shortened_version }}      
      build_id: ${{ inputs.build_id }}
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}
      releases_prefix: ${{ inputs.releases_prefix }}
      dev_tools_version: ${{ inputs.version }}
    secrets: inherit

  # Build appserver and tools images (depends on build, runs in parallel)
  build-platform-appserver-tools:
    needs: [setup, build-platform-build]
    uses: IQGeo/devops-engineering-ci-public-build-platform-specialised-image-workflow/.github/workflows/build-specialised-images.yml@main
    with:
      version: ${{ inputs.version }}
      image_types: '["appserver", "tools"]'
      updated_tags: ${{ inputs.tags }}
      build_id: ${{ inputs.build_id }}
      shortened_version: ${{ inputs.shortened_version }}      
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}
      releases_prefix: ${{ inputs.releases_prefix }}
      dev_tools_version: ${{ inputs.version }}
    secrets: inherit

  # Build devenv and devenv-clear images (depends on appserver-tools)
  build-platform-devenv:
    needs: [setup, build-platform-appserver-tools]
    uses: IQGeo/devops-engineering-ci-public-build-platform-specialised-image-workflow/.github/workflows/build-specialised-images.yml@main
    with:
      version: ${{ inputs.version }}
      image_types: '["devenv-2", "devenv-2-clear"]'
      updated_tags: ${{ inputs.tags }}
      shortened_version: ${{ inputs.shortened_version }}      
      build_id: ${{ inputs.build_id }}
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}
      releases_prefix: ${{ inputs.releases_prefix }}
      dev_tools_version: ${{ inputs.version }}
    secrets: inherit
    
  build-platform-devdb-qa-images:
    if: ${{ inputs.build_qa_images == true }}    
    needs: [setup, build-injectors, build-platform-appserver-tools]
    uses: IQGeo/devops-engineering-ci-public-build-platform-specialised-image-workflow/.github/workflows/build-devdb-qa-images.yml@main
    with:
      version: ${{ inputs.version }}
      modules: ${{ inputs.modules }}
      updated_tags: ${{ inputs.tags }}    
      build_id: ${{ inputs.build_id }}
      is_release: ${{ inputs.is_release }}
      engineering_prefix: ${{ inputs.engineering_prefix }}
      releases_prefix: ${{ inputs.releases_prefix }}
    secrets: inherit

  redeploy-eks-pod:
    if: ${{ inputs.namespace != '' && inputs.pod_name != '' && inputs.build_qa_images == true }}
    needs: [build-platform-devdb-qa-images]
    uses: IQGeo/devops-engineering-ci-redeploy-eks-pod/.github/workflows/redeploy-eks-pod.yml@main
    with:
      pod_name: ${{ inputs.pod_name }}
      namespace: ${{ inputs.namespace }}
    secrets: inherit
